## Бизнес-процессы





### "Отправка отчетов по пользователям"

#### Легенда *Контекст
  * Контрольный период - период в рамках которого происходит отправка вендором письмо с запросом отчета, формирования нами отчета, отправка нами ответным письмом этого отчета
  * письмо-запроса
  * отчеты
  * файл-шаблон
_письмо-результата_
_письмо-статуса_
Типизация
#### ParsedMailI

#### Переменные
```js
$COMPANY_ID = 1754;

$R__ADMIN; // Админ - Сущность, роль которой принимать уведомля об некоректной работе программы
$ACCOUNT__MAIL; // Аккаунт почты - обьект хранящий данные для авторизации в почтовом клиенте
$ACCOUNT__ASRV; // Аккаунт для АСРВ - обьект хранящий данные для авторизации в сервисе asrp.cntd.ru
$ACCOUNT__COPY_BASE; // Аккаунт для CopyBase - обьект хранящий данные для авторизации в сервисе copybase.ru
$ACCOUNT__ASVO; // Аккаунт для АСВО - обьект хранящий данные для авторизации в сервисе ask.kodeks.ru

$REPORT_PING_TIME;
$DEAD_CLOSE_TIME;
$PERIOD_CLAIMING_REPORTS;

$claimMailUrl;
$sendedReportUrl;
$parsedMail;
$report;
``

#### Подготовка
* Авторизироваться на https://mail.360.yandex.ru используя `$ACCOUNT__MAIL`
* Авторизироваться на https://asrp.cntd.ru используя `$ACCOUNT__ASRV`
* Авторизироваться на https://copybase.ru используя `$ACCOUNT__COPY_BASE`
* Авторизироваться на https://ask.kodeks.ru/ используя `$ACCOUNT__ASVO`

#### Основное
1. Ожидаем на сайте https://mail.360.yandex.ru получения _письмо-запроса_ *(Пример письма №1) содержащего:
  - отправителя - `regmanager2@kodeks.ru`
  - заголовок - `Снятие Sysinfo`
* В случае если письмо не неприходит в рамках даты *(`$PERIOD_CLAIMING_REPORTS[1] - 12часов`), уведомляем об это `$R__ADMIN`
<!-- TODO: Решить да/нет переводить ли полностью на ручной выполение этого БП *("Отправка отчетов по пользователям"), в случае если не было отправленно вендором _письмо-запроса_ в контрольный период -->
2. Запоминаем ссылку на _письмо-запроса_ в `$claimMailUrl` и парсим _письмо-запроса_, в обьект `$parsedMail`, таким образом что получаем из *([Часть письма] = [имя поля ParsedMailI] = [Значение]):
  - `FILE: Исключения шаблон xlsx` -> `template = {blob: Blob, type: "xlsx" | "pdf"}`
  - `Актуальными будут считаться отчеты, снятые и загруженные с 01.09.25 по 05.10.25 включительно.` -> `deadline = [01.09.25, 05.10.25]`
3.  

4. Переходим на сайт https://asrp.cntd.ru/?module=reports
5. Кликаем по вкалдке "Статистка", ждем....
6. Кликаем по пункту "SysInfo. Текущий статус обновления действующих установок", ждем....
7. В появившейся панели, перед нажатием на "Применить", вносим данные так чтобы:
  - в поле "Представитель" было значение `$COMPANY_ID`
  = Чекбокс "Только с ошибками" был активным
8. В панели нажимаем на кнопку "Применить", ждем....
8. В появившейся таблице, !!! УТОЧНИТЬ !!!, получаем _отчеты_

9. _Отчеты_ приобразуем в файл `$report` используя _файл-шаблон_ `$parsedMail["template"]`.
10. Переходим на сайт https://ask.kodeks.ru/welcome/ask
11. Кликаем по пункту "Подать заявление", ждем....
12. Появившуюся форму так, чтобы:
  - в поле `Вопрос` был текст вида `Добрый день коллеги. Прикладываю исключения за $parsedMail["deadline"]`
  - в поле `Прикрепленный файл` был прикреплен файл `$report`
  - в поле `E mail` значение `ACCOUNT__MAIL["login"]`
  - в поле `Код пользователя` было указано значение `$COMPANY_ID`
13. Нажать кнопку "Отправить", Ждем...
14. Переходим на сайт, по ссылке вида ``` `https://ask.kodeks.ru/welcome/search?nacc=${$ACCOUNT__ASVO}&order=1&order_dir=2&step=1` ```
15. Парсим страницу, получая самую актуальную заявку и запоминаем ссылку на заявку в `$sendedReportUrl`
14. Ожидаем на сайте https://mail.360.yandex.ru: истечения таймера на время `$REPORT_PING_TIME`, наступления даты *(`ParsedMailI["deadline"][1] - $DEAD_CLOSE_TIME`) или получения _письмо-статуса_ *(Пример письма №2) содержащего:
  - cтатус `В работе` или  | `В ожидании`
  * В случае если истек таймер или наступила дата раньше чем пришло _письмо-статуса_, прекрашяем все ожидания и уведомляем об это `$R__ADMIN`, соопроводив уведомление: _скринкастом отправляемого шаблона_ и ссылкой на _письмо-запроса_
15. Ожидаем на сайте https://mail.360.yandex.ru: наступления даты *(`ParsedMailI["deadline"][1] - $DEAD_CLOSE_TIME`) или получения _письмо-результата_ *(Пример письма №3) содержащего:
  - cтатус `Принято успешно` | `Отправленно на доработку`
  * В случае если дата настпает раньше чем пришло _письмо-результата_, уведомляем об это `$R__ADMIN`, соопроводив уведомление: ссылкой на _письмо-запроса_ и значением `$sendedReportUrl`
  * В случае если статус сообщения имеет значение `Отправленно на доработку`, уведомляем об это `$R__ADMIN`, соопроводив уведомление: ссылкой на _письмо-запроса_ и значением `$sendedReportUrl`

##### Приложение
* Пример письмо №1:
```
  Снятие Sysinfo за сентябрь 2025г.! ВАЖНО

  regmanager2@kodeks.ru regmanager2@kodeks.ru 18 сентября в 12:58

  FILE: Исключения шаблон xlsx



  Добрый день!

  Коллеги, обращаем ваше внимание, что снятие статистики по отчетам Sysinfo за сентябрь 2025 г. будет сделано автоматически 06.10.25.

  Актуальными будут считаться отчеты, снятые и загруженные с 01.09.25 по 05.10.25 включительно.

    Если у вас есть пользователи, у которых вы в силу объективных обстоятельств не смогли снять и загрузить отчет, то просим до 03.10.25 до 12:00 по московскому времени (обращаю внимание не позже) выслать заполненный шаблон
    с указанием причин исключения в АСВО.

    Помним, что загрузка должна быть не менее 90% эти цифры влияют на ваши проценты отчислений по договору.


    С уважением, Валетова Валентина
    менеджер сектора информационной поддержки представителей,
    Управления поддержки представителей и пользователей
    АО «Информационная компания «Кодекс»
    тел. (812)740-78-86, доп. 551
```
* Пример письма №2:
```
!!! УТОЧНИТЬ !!!
```
