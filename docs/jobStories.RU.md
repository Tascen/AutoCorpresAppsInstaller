## Бизнес-процессы

> Каждом из представленных ниже БП в под теме "Типизация" используется псевдо Typescript 




### "Внесение изменений в локальную установку"

#### Легенда *Контекст
  * строк-задачь на изменение данных

#### Типизация
```ts```

#### Переменные
```js
$TASK = 1754;

$R__ADMIN; // Админ - Сущность, роль которой принимать уведомления об некорректной работе программы
$ACCOUNT__MEGAPLAN; // Аккаунт для Megaplan - объект хранящий данные для авторизации в сервисе escoltacloud.megaplan.ru
```

#### Подготовка
* Авторизоваться на https://escoltacloud.megaplan.ru/ используя `$ACCOUNT__MEGAPLAN`

#### Основное
1. Ожидаем на сайте [escoltacloud.megaplan.ru](https://escoltacloud.megaplan.ru/task/filter/all) появления в таблице новых _строк-задачь на изменение данных_ *(Пример _строки-задачи_ №1) содержащей:
  <!-- -задача - `Формирование доступа для нового специалиста, рег. 274828` -->
  - дедлайн - `	10 октября`
  - _ссылка-задачи_ - `/task/1012628/card/`
2) Парсим новые строки в обьекты `$TASK` и на их основе порождаем одну или несколько самовыполняемых задач, по карте условий:
  - `$TASK["newAccs"].length > 0` -> BR "Создание учетной записи пользователя приложением"
  - `$TASK["remAccs"]` -> BR "Удаление учетной записи пользователя приложением"
  <!-- - `$TASK["oldAccs"]` -> BR "Удаление учетной записи пользователя приложением" -->
  - `$TASK["remAccs"]` -> BR "Удаление учетной записи пользователя приложением"
  - `$TASK["newReg"]` -> BR "Замена рег.файла"
  - `$TASK["isNotAllowed"]` -> BR "Замена рег.файла"

Переходим по _ссылка-задачи_ взятой из _строки-задачи_ *(на другой сайт). Ждем...
3) На сайте парсим данные, более 

##### Приложение
* Пример строки-задачи №1:
```html
<tr>
  <td></td>
  <td>
    <label data-name="toggleChecked">
      <div>
        <input type="checkbox">
        <div style="align-self: center;">
          <span data-name="59975" data-icon=""></span>
        </div>
      </div>
    </label>
  </td>
  <td></td>
  <td data-tooltip="Ежедневный мониторинг обновлений на CopyBase">
    <a target="_self" data-link="true" href="/task/1012201/card/">
      Разворачивание тестовой установки
    </a>
  </td>
  <td>
    10&nbsp;октября в&nbsp;17:22
  </td>
  <td></td>
  <td>
    <div data-name="user">
      <div>
        <div>
          <div data-block="Avatar" title="">
            <div>
              <div style="background-color: rgb(132, 138, 171);">
                <div>ТА</div>
              </div>
            </div>
            <div><div></div></div>
          </div>
        </div>
        <div>
          <div data-name="userName">
            <a target="_blank" data-link="true" href="/staff/1000132/card/">
              <div data-text="Тимофеев Александр">
                <div>Тимофеев Александр</div>
              </div>
            </a>
          </div>
        </div>
        <div>
          <div></div>
          <div>
            <div data-text="Специалист технической поддержки, ИТ специалист">
              <div>Специалист технической поддержки, ИТ специалист</div>
            </div>
          </div>
        </div>
        <div></div>
      </div>
    </div>
  </td>
  <td>
    <div data-name="user">
      <div>
        <div>
          <div data-block="Avatar" title="">
            <div>
              <div style="background-image: url(&quot;//pc31.megaplan.ru/hosts/escoltacloud.megaplan.ru/100x100/attach/BumsPerson/SmallPhoto/247/49/face8891b272d3de0da16d64b2234770.png&quot;);">
            </div>
            <div><div></div></div>
          </div>
        </div>
        <div>
          <div data-name="userName">
            <a target="_blank" data-link="true" href="/staff/1000132/card/">
              <div data-text="Хрущева Яна">
                <div>Хрущева Яна</div>
              </div>
            </a>
          </div>
        </div>
        <div>
          <div></div>
          <div>
            <div data-text="Исполнительный директор">
              <div>Исполнительный директор</div>
            </div>
          </div>
        </div>
        <div></div>
      </div>
    </div>
  </td>
  <td >0 / 0</td>
  <td></td>
  <td >
    <button title="Добавить в избранное" data-name="favorite" type="button">
      <div>
        <div timeout="[object Object]">
          <span data-name="60036" data-icon=""></span>
          <span></span>
        </div>
      </div>
    </button>
  </td>
  <td></td>
</tr>
```





### "Отправка еженедельных отчетов по пользователям"
> 

#### Легенда *Контекст
  * рег.номером
  * хранилище отчетов
  * отчет
  * статус отчета ожидается
  * статус отчета успешный
  * статус отчета ошибка

#### Типизация
```ts
interface ClientI {
  deadline: [Date, Date],
  template: File.xlsx
}
```

#### Переменные
```js
$ACCOUNT__ASRV; // Аккаунт для АСРВ - объект хранящий данные для авторизации в сервисе asrp.cntd.ru

$LOCAL_SERVERS_REPORT_DATE; // Дата каждого месяца, начиная с которой необходимо в течении суток отправить все отчеты
$INSTALLATIONS_TABLE; // Xlsx таблица, содержащая информацию о об установленных приложения техэксперт; где утановлена, как долго будет длиться лицензия и.т.д...
//    данная таблица лежитт по пути "Z:\Common\Файлообменник\Хрущев Владимир\Клиенты\YandexDisk\backup\Физические клиенты.xlsx"
$LOCAL_SERVERS_REPORT_MAP // Xlsx таблица исключений, указываюзая на то какие из установок не имеют доступа, с указанием ошибки и её причины 

$CLIENT; // обьект полезный тем что хранит в себе регфайл, а так же второстепеную информацию позволяющую выявить ошибки  и успешо их обработотьЫ 

```

#### Подготовка
* Авторизоваться на [ASRV](https://asrp.cntd.ru) используя `$ACCOUNT__ASRV`

#### Основное
1. Ожидание наступления даты `$LOCAL_SERVERS_REPORT_DATE`
2. Открываем документ `$INSTALLATIONS_TABLE` и в нём итерируемся по строкам таблиц чьи названия похожи на `Сервер 1 - IP 123.123.123.123 Строка привязки: 065NV-G1N8U-A6D`
3. Преобразуем каждую строку таблицы в объект `$CLIENT` *(хранящийся в `$LOCAL_SERVERS_REPORT_MAP`), таким образом, что получаем: \
  *([Колонка строки] -> `ClientI[keyof ClientI]`)
  - `Название` -> `$CLIENT[name]`
  - `рег.номер` -> `$CLIENT[regNum]`
  - `Адрес установки` -> `$CLIENT[url]`
  - `Порт` -> `$CLIENT[port]`
  - `Обновление баз` -> `$CLIENT[dbVer]`
  <!-- - `Версия ПК` -> `$CLIENT[pcver]` -->
  - `Триал дата` *(начало, осталось) -> `$CLIENT[0]`ссылка-задачи
4. Переходим на роут `sysinfo` сайта указанного одним из значений полей `$CLIENT[url]` и `$CLIENT[url-hard]`  выбираем
* В случае если не удалось перейти на страницу, то пытаемся решить проблему с доступом *(BR "Решение проблемы с отсутствием доступа к локальной установке"), в случае неуспеха изменяем статус _отчета_ в `$LOCAL_SERVERS_REPORT_MAP` и уведомляем об этом `$R__ADMIN`, сопроводив уведомление _рег.номером_
5. Скачиваем _отчет_ в _хранилище отчетов_
6. Ждем завершения пока итерация шага 3 не выполнит все вызовы шагов 3-5
7. Переходим на сайт [ASRV](https://asrp.cntd.ru)
8. Кликаем по вкладке "Сотрудники", ждем....
9. В _таблице-сотрдуники_ кликаем по кнопке "Загрузить отчеты" той строчки чей столбец равен значению `$CLIENT["login"]`, ждем....
* В случае если строки чей столбец равен значению `$CLIENT["login"]` нет, уведомляем об этом `$R__ADMIN`, сопроводив уведомление _рег.номером_
10. На странице "Загрузить отчет", кликаем по кнопке "Выбрать файлы" и указываем в качестве файлов все _отчеты_, кроме тех которые имеют _статус отчета ошибка_ в файле `$LOCAL_SERVERS_REPORT_MAP` хранящиеся в _хранилище _отчетов_
12. Начинаем ожидать когда каждый из _отчетов_ на странице меняет своё состояние *(первый столбец) c _статус отчета ожидается_ на _статус отчета успешный_ или _статус отчета ошибка_
* В случае когда у _отчета_ появляется _статус отчета ошибка_, уведомлять об этом `$R__ADMIN`, сопроводив уведомление _рег.номером_
13. После изменения состояние у отчета, обновляем информацию о статусе _отчета_ в файл `$LOCAL_SERVERS_REPORT_MAP`
11. После того как все _отчеты_ изменили своё состояние, уведомляем об этом `$R__ADMIN`, сопроводив файлом `$LOCAL_SERVERS_REPORT_MAP`





### "Отправка ежемесячных отчетов по пользователям"

#### Легенда *Контекст
  * Контрольный период - период в рамках которого происходит отправка вендором письмо с запросом отчета, формирования нами отчета, отправка нами ответным письмом этого отчета
  * письмо-запроса
  * отчеты
  * файл-шаблон
  * письмо-результата_
  * письмо-статуса
  * рег.номером
  * письмо

#### Типизация
```ts
interface ParsedMailI {
  deadline: [Date, Date],
  template: File.xlsx
}
```

#### Переменные
```js
$COMPANY_ID = 1754;

$R__ADMIN; // Админ - Сущность, роль которой принимать уведомления об некорректной работе программы
$ACCOUNT__MAIL; // Аккаунт почты - объект хранящий данные для авторизации в почтовом клиенте
$ACCOUNT__ASRV; // Аккаунт для АСРВ - объект хранящий данные для авторизации в сервисе asrp.cntd.ru
$ACCOUNT__COPY_BASE; // Аккаунт для CopyBase - объект хранящий данные для авторизации в сервисе copybase.ru
$ACCOUNT__ASVO; // Аккаунт для АСВО - объект хранящий данные для авторизации в сервисе ask.kodeks.ru

$REPORT_PING_TIME;
$DEAD_CLOSE_TIME;
$PERIOD_CLAIMING_REPORTS;

$claimMailUrl;
$sendedReportUrl;
$parsedMail;
$report;
```

#### Подготовка
* Авторизоваться на https://mail.360.yandex.ru используя `$ACCOUNT__MAIL`
* Авторизоваться на [ASRV](https://asrp.cntd.ru) используя `$ACCOUNT__ASRV`
* Авторизоваться на https://copybase.ru используя `$ACCOUNT__COPY_BASE`
* Авторизоваться на https://ask.kodeks.ru/ используя `$ACCOUNT__ASVO`

#### Основное
1. Ожидаем на сайте https://mail.360.yandex.ru получения _письмо-запроса_ *(Пример письма №1) содержащего:
  - отправителя - `regmanager2@kodeks.ru`
  - заголовок - `Снятие Sysinfo`
* В случае если _письмо_ не приходит в рамках даты *(`$PERIOD_CLAIMING_REPORTS[1] - 12часов`), уведомляем об этом `$R__ADMIN`
<!-- TODO: Решить да/нет переводить ли полностью на ручной выполение этого БП *("Отправка отчетов по пользователям"), в случае если не было отправленно вендором _письмо-запроса_ в контрольный период -->
2. Запоминаем ссылку на _письмо-запроса_ в `$claimMailUrl` и парсим _письмо-запроса_, в объект `$parsedMail`, таким образом, что получаем: \
  *([Часть письма] -> [имя поля ParsedMailI] = [Значение])
  - `FILE: Исключения шаблон xlsx` -> `template = {blob: Blob, type: "xlsx" | "pdf"}`
  - `Актуальными будут считаться отчеты, снятые и загруженные с 01.09.25 по 05.10.25 включительно.` -> `deadline = [01.09.25, 05.10.25]`
3.  

4. Переходим на сайт [ASRV](https://asrp.cntd.ru)
5. Кликаем по вкладке "Статистка", ждем....
6. Кликаем по пункту "SysInfo. Текущий статус обновления действующих установок", ждем....
7. В появившейся панели, перед нажатием на "Применить", вносим данные так чтобы:
  - в поле "Представитель" было значение `$COMPANY_ID`
  = Чекбокс "Только с ошибками" был активным
8. В панели нажимаем на кнопку "Применить", ждем....
8. В появившейся таблице, !!! УТОЧНИТЬ !!!, получаем _отчеты_

9. _Отчеты_ преобразуем в файл `$report` используя _файл-шаблон_ `$parsedMail["template"]`.
10. Переходим на сайт https://ask.kodeks.ru/welcome/ask
11. Кликаем по пункту "Подать заявление", ждем....
12. Появившуюся форму заполняем так, чтобы:
  - в поле `Вопрос` был текст вида `Добрый день коллеги. Прикладываю исключения за $parsedMail["deadline"]`
  - в поле `Прикрепленный файл` был прикреплен файл `$report`
  - в поле `E mail` значение `ACCOUNT__MAIL["login"]`
  - в поле `Код пользователя` было указано значение `$COMPANY_ID`
13. Нажать кнопку "Отправить", Ждем...
14. Переходим на сайт, по ссылке вида ``` `https://ask.kodeks.ru/welcome/search?nacc=${$ACCOUNT__ASVO}&order=1&order_dir=2&step=1` ```
15. Парсим страницу, получая самую актуальную заявку и запоминаем ссылку на заявку в `$sendedReportUrl`
14. Ожидаем на сайте https://mail.360.yandex.ru: истечения таймера на время `$REPORT_PING_TIME`, наступления даты *(`ParsedMailI["deadline"][1] - $DEAD_CLOSE_TIME`) или получения _письмо-статуса_ *(Пример письма №2) содержащего:
  - cтатус `В работе` или  | `В ожидании`
  * В случае если истек таймер или наступила дата раньше чем пришло _письмо-статуса_, прекращаем все ожидания и уведомляем об это `$R__ADMIN`, сопроводив уведомление: _скринкастом отправляемого шаблона_ и ссылкой на _письмо-запроса_
15. Ожидаем на сайте https://mail.360.yandex.ru: наступления даты *(`ParsedMailI["deadline"][1] - $DEAD_CLOSE_TIME`) или получения _письмо-результата_ *(Пример письма №3) содержащего:
  - cтатус `Принято успешно` | `Отправленно на доработку`
  * В случае если дата наступает раньше чем пришло _письмо-результата_, уведомляем об это `$R__ADMIN`, сопроводив уведомление: ссылкой на _письмо-запроса_ и значением `$sendedReportUrl`
  * В случае если статус сообщения имеет значение `Отправленно на доработку`, уведомляем об это `$R__ADMIN`, сопроводив уведомление: ссылкой на _письмо-запроса_ и значением `$sendedReportUrl`

##### Приложение
* Пример _письма_ №1:
```
  Снятие Sysinfo за сентябрь 2025г.! ВАЖНО

  regmanager2@kodeks.ru regmanager2@kodeks.ru 18 сентября в 12:58

  FILE: Исключения шаблон xlsx
  Разворачивание приложения Kodeks



  Добрый день!

  Коллеги, обращаем ваше внимание, что снятие статистики по отчетам Sysinfo за сентябрь 2025 г. будет сделано автоматически 06.10.25.

  Актуальными будут считаться отчеты, снятые и загруженные с 01.09.25 по 05.10.25 включительно.

    Если у вас есть пользователи, у которых вы в силу объективных обстоятельств не смогли снять и загрузить отчет, то просим до 03.10.25 до 12:00 по московскому времени (обращаю внимание не позже) выслать заполненный шаблон
    с указанием причин исключения в АСВО.

    Помним, что загрузка должна быть не менее 90% эти цифры влияют на ваши проценты отчислений по договору.


    С уважением, Валетова Валентина
    менеджер сектора информационной поддержки представителей,
    Управления поддержки представителей и пользователей
    АО «Информационная компания «Кодекс»
    тел. (812)740-78-86, доп. 551
```
* Пример _письма_ №2:
```
!!! УТОЧНИТЬ !!!
```
